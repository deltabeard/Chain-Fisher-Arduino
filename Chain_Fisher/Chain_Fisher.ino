/*
  2014 Mahyar Koshkouei
  
  Chain Fisher
*/

#include <EEPROM.h>
#include <Adafruit_GFX.h>
#include <Adafruit_PCD8544.h>

// Below are hte usual pins for connecting to a Nokia 5110 LCD
// pin 7 - Serial clock out (SCLK)
// pin 6 - Serial data out (DIN)
// pin 5 - Data/Command select (D/C)
// pin 4 - LCD chip select (CS)
// pin 3 - LCD reset (RST)

Adafruit_PCD8544 display = Adafruit_PCD8544(13, 11, 7, 12, 10);
// My Nokia 5110 LCD requires different pins than the usual because it's a wierd one.

// Below are variable for use with a Funduino Joystick Shield V1.A, although most of the buttons aren't needed for this game.
byte up_button = 2;
byte down_button = 4;
byte left_button = 5;
byte right_button = 3;
byte start_button = 6;
byte select_button = 7;
byte analog_button = 8;
byte x_axis = A0;
byte y_axis = A1;
byte buttons[] = {up_button, down_button, left_button, right_button, start_button, select_button, analog_button};

int highScore = 0; // Scores high score retrieved from EEPROM
int score = 0;     // Current user score
int timeStart = 0; // To store millis()
int timeEnd = 0;    // To store time in which user has to press A and reel in fish
boolean hooked = false;  // To see is fish is hooked

// Below are the bitmaps used in this game.

//------------------------------------------------------------------------------
// File generated by LCD Assistant
// http://en.radzio.dxp.pl/bitmap_converter/
//------------------------------------------------------------------------------
// 75x27
const unsigned char PROGMEM start [] = {
0x00, 0xFF, 0x30, 0x30, 0x08, 0x0F, 0xFC, 0x60, 0x60, 0x00, 0x01, 0xFF, 0x30, 0x30, 0x1C, 0x0F,
0xFC, 0x70, 0x60, 0x00, 0x03, 0xC1, 0x30, 0x30, 0x3E, 0x00, 0xC0, 0x78, 0x60, 0x00, 0x03, 0x00,
0x30, 0x30, 0x36, 0x00, 0xC0, 0x78, 0x60, 0x00, 0x06, 0x00, 0x30, 0x30, 0x26, 0x00, 0xC0, 0x6C,
0x60, 0x00, 0x06, 0x00, 0x3F, 0xF0, 0x63, 0x00, 0xC0, 0x6E, 0x60, 0x00, 0x06, 0x00, 0x3F, 0xF0,
0x63, 0x00, 0xC0, 0x66, 0x60, 0x00, 0x06, 0x00, 0x30, 0x30, 0xC1, 0x80, 0xC0, 0x67, 0x60, 0x00,
0x06, 0x00, 0x30, 0x30, 0xFF, 0x80, 0xC0, 0x63, 0x60, 0x00, 0x03, 0x00, 0x30, 0x31, 0xFF, 0xC0,
0xC0, 0x61, 0xE0, 0x00, 0x03, 0xC1, 0x30, 0x31, 0x80, 0xC0, 0xC0, 0x61, 0xE0, 0x00, 0x01, 0xFF,
0x30, 0x31, 0x80, 0xCF, 0xFC, 0x60, 0xE0, 0x00, 0x00, 0x7E, 0x30, 0x33, 0x00, 0x6F, 0xFC, 0x60,
0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x8F, 0xFC, 0x1F,
0x83, 0x03, 0x0F, 0xF8, 0xFE, 0x00, 0xFF, 0x8F, 0xFC, 0x3F, 0xC3, 0x03, 0x0F, 0xF8, 0xFF, 0x00,
0xC0, 0x00, 0xC0, 0x60, 0x43, 0x03, 0x0C, 0x00, 0xC3, 0x80, 0xC0, 0x00, 0xC0, 0x60, 0x03, 0x03,
0x0C, 0x00, 0xC1, 0x80, 0xC0, 0x00, 0xC0, 0x70, 0x03, 0x03, 0x0C, 0x00, 0xC1, 0x80, 0xFF, 0x00,
0xC0, 0x3C, 0x03, 0xFF, 0x0F, 0xE0, 0xC3, 0x80, 0xFF, 0x00, 0xC0, 0x0F, 0x83, 0xFF, 0x0F, 0xE0,
0xFF, 0x00, 0xC0, 0x00, 0xC0, 0x03, 0xC3, 0x03, 0x0C, 0x00, 0xFE, 0x00, 0xC0, 0x00, 0xC0, 0x00,
0x63, 0x03, 0x0C, 0x00, 0xC7, 0x00, 0xC0, 0x00, 0xC0, 0x00, 0x63, 0x03, 0x0C, 0x00, 0xC3, 0x80,
0xC0, 0x00, 0xC0, 0x60, 0xE3, 0x03, 0x0C, 0x00, 0xC1, 0xC0, 0xC0, 0x0F, 0xFC, 0x7F, 0xC3, 0x03,
0x0F, 0xF8, 0xC0, 0xE0, 0xC0, 0x0F, 0xFC, 0x3F, 0x83, 0x03, 0x0F, 0xF8, 0xC0, 0x60, 0x00, 0x00,
0x78, 0x33, 0x30, 0x2C, 
};


//------------------------------------------------------------------------------
// File generated by LCD Assistant
// http://en.radzio.dxp.pl/bitmap_converter/
//------------------------------------------------------------------------------
const unsigned char PROGMEM fisherman [] = {
0x00, 0x00, 0x07, 0x80, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x40, 0x00,
0x00, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0xA0, 0x00, 0x00, 0x31, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x08, 0x10, 0x00, 0x00, 0xC1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x20,
0x00, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x40, 0x00, 0x18, 0x01, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x07, 0xC0, 0x00, 0x60, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04,
0x40, 0x03, 0x80, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x60, 0x0C, 0x00, 0x01, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x1E, 0x30, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x04, 0x12, 0x40, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x72, 0x80, 0x00, 0x01,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x5F, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x04, 0x70, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x08, 0x00, 0x00,
0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x07, 0xE4, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xA4, 0x00,
0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x67, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x10, 0x61, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x61,
0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xC0, 0x00, 0x01, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x40, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x01, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x40, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x01,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x40, 0x08, 0x01, 0x00, 0x20, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x14,
0x03, 0x80, 0x50, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x50, 0x22, 0x05, 0x40, 0x88, 0x11, 0x00,
0x00, 0x00, 0x00, 0x00, 0x48, 0x41, 0x09, 0x21, 0x04, 0x20, 0x80, 0x00, 0x00, 0x00, 0x00, 0x47,
0x80, 0xF1, 0x1E, 0x03, 0xC0, 0x70, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x01, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x40, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};



void setup() {
  //Initialise the Joystick shield
  for (int i; i < 7; i++)
  {
   pinMode(buttons[i], INPUT);
   digitalWrite(buttons[i], HIGH);
  }
  
  display.begin();
  // init done

  // you can change the contrast around to adapt the display
  // for the best viewing!
  display.setContrast(50);
  delay(500);
  display.clearDisplay();   // clears the screen and buffer
  menu();
}

void menu() {
  display.clearDisplay();   // clears the screen and buffer
  display.drawBitmap(5, 1, start, 75, 27, BLACK); // Display Start screen bitmap
  display.setTextSize(1);
  display.setTextColor(BLACK, WHITE);
  display.setCursor(18, 30);
  display.println("Press A");  // Print text
  highScore = EEPROM.read(0);
  display.print("High Score: ");
  display.println(highScore);
  display.display();    // Display on LCD
  
  while (digitalRead(up_button) == HIGH) {      // Loop until user presses button
    //Do nothing
    delay(5);
  }
  display.setCursor(0, 30);
  display.setTextSize(2);
  display.print(" READY?");
  display.display();
  delay(2000);
  score = 0; // reset score
  loop();
}

void loop() {
  hooked = false;    // Reset hooked variable
  
  display.clearDisplay();
  display.drawBitmap(0, 4, fisherman, 84, 44, BLACK);    // Display fisherman bitmap
  display.setCursor(0, 40);
  display.setTextSize(1);
  display.print(score);
  display.display();
  
  timeEnd = millis() + 4000;    // millis() + delay when nothing is shown (will be random in the future).
  while (millis() < timeEnd) {
    if (digitalRead(up_button) == LOW) {
      gameOver();
    }
  }
  
  display.setCursor(0, 0);
  display.setTextSize(1);
  display.println("!");    // Show on screen that a fish is hooked
  display.display();
  delay(10);          // Delay to make sure that the screen is showing the '!' before the timer starts
  
  timeEnd = millis() + 2000;    // millis() + delay the user has to press A.
  
  while (millis() < timeEnd) {
    if (digitalRead(up_button) == LOW) {
      hooked = true;    // Fish hooked
      timeEnd = millis() - 10;
    }
  }
  
  if (hooked == false) {
    gameOver();
  } else {
    score++;
  }
  
  while (digitalRead(up_button) == LOW) {    // this is to stop the game to go to gameover quickly
    // Do nothing
    delay(5);
  }
  
}

void gameOver() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(BLACK, WHITE);
  display.setCursor(0, 0);
  display.println("Game End");  // Print text
  display.println(score);
  
  if (score > highScore) {
    EEPROM.write(0, score);      // Save score on EEPROM
            // Add check to make sure score is a byte (0<score<255)
    display.println("New high score saved!");
  }
  
  display.println("Press A");
  display.display();
  
  while (digitalRead(up_button) == LOW) {
    // Do nothing
    delay(5);
  }
  
  delay(500);
  
  if (digitalRead(up_button) == LOW) {
    menu();
  }
  
}
